# Copyright 2023 NST Co., Ltd.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

import numpy as np


def DSPfir(data, coefficients):
    result = 0
    n = len(data) // 2

    result += data[n] * coefficients[0]

    for i in range(1, len(coefficients)):
        if n - i < 0 or n + i >= len(data):
            return None
        result += (data[n - i] + data[n + i]) * coefficients[i]

    return result


# フィルター係数
coef10000 = [
    0.4918284112,
    0.3167419177,
    0.0080352133,
    -0.1014759804,
    -0.0076357159,
    0.0562020580,
    0.0070093945,
    -0.0355304556,
    -0.0062025112,
    0.0233952727,
    0.0052873603,
    -0.0154309458,
    -0.0043138225,
    0.0099815503,
    0.0033805396,
    -0.0061854473,
    -0.0024781874,
    0.0036575476,
    0.0017724848,
    -0.0019043044,
    -0.0010492156,
    0.0010175328,
    0.0007693933,
    -0.0002355342,
    -0.0002983295,
]
coef5000 = [
    0.2459083720,
    0.2219172761,
    0.1583895940,
    0.0770891103,
    0.0040431549,
    -0.0408253836,
    -0.0507548553,
    -0.0330255407,
    -0.0038259055,
    0.0199841191,
    0.0281523698,
    0.0201873796,
    0.0035350194,
    -0.0116029650,
    -0.0178080965,
    -0.0136083947,
    -0.0031144519,
    0.0070902551,
    0.0117678068,
    0.0094850826,
    0.0026801143,
    -0.0042914371,
    -0.0077675019,
    -0.0065697764,
    -0.0021751532,
    0.0025389218,
    0.0050605101,
    0.0044943778,
    0.0017283536,
    -0.0013734855,
    -0.0031393843,
    -0.0029292868,
    -0.0012620530,
    0.0006958178,
    0.0018778031,
    0.0018535324,
    0.0009124288,
    -0.0002512415,
    -0.0009947537,
    -0.0010486655,
    -0.0005639213,
    0.0000740907,
    0.0005067700,
    0.0005796398,
    0.0003632647,
    0.0000498489,
    -0.0001831598,
    -0.0002589514,
    -0.0002057426,
    -0.0001161467,
]
coef2500 = [
    0.1229372429,
    0.1198687425,
    0.1109423300,
    0.0969646359,
    0.0791816376,
    0.0591435651,
    0.0385391354,
    0.0190188367,
    0.0020279543,
    -0.0113315937,
    -0.0203955199,
    -0.0249782141,
    -0.0253580308,
    -0.0222111622,
    -0.0165045400,
    -0.0093627600,
    -0.0019264903,
    0.0047800364,
    0.0099569549,
    0.0131006146,
    0.0140330874,
    0.0128888467,
    0.0100636250,
    0.0061349674,
    0.0017669807,
    -0.0023870812,
    -0.0057714950,
    -0.0079935146,
    -0.0088607380,
    -0.0083878440,
    -0.0067744842,
    -0.0043598800,
    -0.0015623956,
    0.0011862674,
    0.0035026717,
    0.0051008535,
    0.0058233661,
    0.0056514221,
    0.0046945690,
    0.0031631803,
    0.0013291949,
    -0.0005182660,
    -0.0021156280,
    -0.0032599915,
    -0.0038323285,
    -0.0038065151,
    -0.0032442070,
    -0.0022776046,
    -0.0010837216,
    0.0001453341,
    0.0012313923,
    0.0020344265,
    0.0024688887,
    0.0025105618,
    0.0021938607,
    0.0016009141,
    0.0008448385,
    0.0000502270,
    -0.0006660125,
    -0.0012107035,
    -0.0015253039,
    -0.0015906065,
    -0.0014252039,
    -0.0010786120,
    -0.0006206442,
    -0.0001290099,
    0.0003228335,
    0.0006758133,
    0.0008920912,
    0.0009579950,
    0.0008830588,
    0.0006957761,
    0.0004370924,
    0.0001528820,
    -0.0001133446,
    -0.0003264449,
    -0.0004636279,
    -0.0005160833,
    -0.0004883257,
    -0.0003956563,
    -0.0002603862,
    -0.0001075591,
    0.0000391054,
    0.0001604667,
    0.0002440380,
    0.0002847414,
    0.0002844297,
    0.0002504416,
    0.0001935649,
    0.0001258238,
    0.0000584616,
    0.0000004058,
    -0.0000426264,
    -0.0000683523,
    -0.0000775616,
    -0.0000733347,
    -0.0000600500,
    -0.0000715274,
]
coef1250 = [
    0.0614635596,
    0.0610778416,
    0.0599295305,
    0.0580449101,
    0.0554669776,
    0.0522542559,
    0.0484791829,
    0.0442261247,
    0.0395890750,
    0.0346691104,
    0.0295716758,
    0.0244037848,
    0.0192712151,
    0.0142757826,
    0.0095127744,
    0.0050686118,
    0.0010188103,
    -0.0025737083,
    -0.0056599093,
    -0.0082055118,
    -0.0101914124,
    -0.0116136638,
    -0.0124830171,
    -0.0128240547,
    -0.0126739480,
    -0.0120808893,
    -0.0111022524,
    -0.0098025485,
    -0.0082512428,
    -0.0065205052,
    -0.0046829667,
    -0.0028095492,
    -0.0009674354,
    0.0007817635,
    0.0023835908,
    0.0037920380,
    0.0049705179,
    0.0058924984,
    0.0065417894,
    0.0069124875,
    0.0070085924,
    0.0068433227,
    0.0064381632,
    0.0058216873,
    0.0050282031,
    0.0040962736,
    0.0030671677,
    0.0019832946,
    0.0008866777,
    -0.0001824856,
    -0.0011871302,
    -0.0020944582,
    -0.0028768719,
    -0.0035126802,
    -0.0039865660,
    -0.0042898065,
    -0.0044202533,
    -0.0043820801,
    -0.0041853206,
    -0.0038452195,
    -0.0033814305,
    -0.0028170941,
    -0.0021778355,
    -0.0014907208,
    -0.0007832105,
    -0.0000821487,
    0.0005871785,
    0.0012018832,
    0.0017421904,
    0.0021920060,
    0.0025393252,
    0.0027764720,
    0.0029001715,
    0.0029114571,
    0.0028154258,
    0.0026208566,
    0.0023397116,
    0.0019865447,
    0.0015778429,
    0.0011313281,
    0.0006652461,
    0.0001976708,
    -0.0002541530,
    -0.0006744041,
    -0.0010491993,
    -0.0013670111,
    -0.0016189781,
    -0.0017991027,
    -0.0019043321,
    -0.0019345269,
    -0.0018923232,
    -0.0017828979,
    -0.0016136512,
    -0.0013938222,
    -0.0011340548,
    -0.0008459321,
    -0.0005414998,
    -0.0002327955,
    0.0000685988,
    0.0003519635,
    0.0006077971,
    0.0008281069,
    0.0010066299,
    0.0011389764,
    0.0012226970,
    0.0012572732,
    0.0012440355,
    0.0011860173,
    0.0010877514,
    0.0009550214,
    0.0007945792,
    0.0006138403,
    0.0004205714,
    0.0002225803,
    0.0000274215,
    -0.0001578724,
    -0.0003270261,
    -0.0004747142,
    -0.0005967086,
    -0.0006899748,
    -0.0007527198,
    -0.0007843875,
    -0.0007856110,
    -0.0007581183,
    -0.0007046063,
    -0.0006285816,
    -0.0005341817,
    -0.0004259826,
    -0.0003087998,
    -0.0001874932,
    -0.0000667810,
    0.0000489299,
    0.0001556898,
    0.0002501288,
    0.0003295474,
    0.0003919763,
    0.0004362058,
    0.0004617829,
    0.0004689802,
    0.0004587395,
    0.0004325925,
    0.0003925641,
    0.0003410637,
    0.0002807683,
    0.0002145025,
    0.0001451220,
    0.0000754033,
    0.0000079427,
    -0.0000549292,
    -0.0001112176,
    -0.0001593157,
    -0.0001980388,
    -0.0002266383,
    -0.0002447990,
    -0.0002526198,
    -0.0002505784,
    -0.0002394852,
    -0.0002204274,
    -0.0001947058,
    -0.0001637688,
    -0.0001291452,
    -0.0000923794,
    -0.0000549706,
    -0.0000183188,
    0.0000163207,
    0.0000478737,
    0.0000754739,
    0.0000984780,
    0.0001164720,
    0.0001292668,
    0.0001368855,
    0.0001395443,
    0.0001376252,
    0.0001316467,
    0.0001222297,
    0.0001100640,
    0.0000958739,
    0.0000803859,
    0.0000642995,
    0.0000482622,
    0.0000328482,
    0.0000185431,
    0.0000057333,
    -0.0000052989,
    -0.0000143758,
    -0.0000214197,
    -0.0000264451,
    -0.0000295473,
    -0.0000308888,
    -0.0000306844,
    -0.0000291853,
    -0.0000266636,
    -0.0000233976,
    -0.0000597367,
]
# デシメーションする比率
rateTable = [16, 8, 4, 2]
# 係数テーブル
coefTable = [coef1250, coef2500, coef5000, coef10000]


def downsample(wave, rate):
    if rate == 1:
        return wave
    rate_index = rateTable.index(rate)
    coefficients = coefTable[rate_index][-1:0:-1] + coefTable[rate_index]

    result = np.convolve(wave, coefficients, mode="valid")

    return result[::rate]
